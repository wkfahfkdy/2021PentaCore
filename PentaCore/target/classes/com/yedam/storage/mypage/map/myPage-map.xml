<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yedam.storage.mypage.map.MyPageMap">
	<select id="noticeSelectList" resultType="MyPageVO" parameterType="MyPageVO">
		select * 
		from notice
		where store_code = #{store_code}
		order by notice_num desc
	</select>
	
	<select id="usedStorageList" resultType="MyPageVO" parameterType="MyPageVO">
		select u.*, s.storage_width, s.storage_height, s.storage_vertical, s.storage_name, o.offer_product,
				o.offer_wash, o.offer_premium
		from storage s join offer o
		on (s.storage_code = o.storage_code)
		join use_storage u
		on (u.offer_code = o.offer_code)
		join store t
		on(u.store_code = t.store_code)
		where u.member_id = #{member_id}
	</select>
	
	<select id="useStorage" resultType="MyPageVO" parameterType="MyPageVO">
		select use_num
		from use_storage
		where member_id = #{member_id}
	</select>
	
	<select id="useStore" resultType="MyPageVO" parameterType="MyPageVO">
		select store_name, info_num
		from use_storage u, store s
		where u.store_code = s.store_code
		and member_id = #{member_id}
	</select>
	
	<select id="userReview" resultType="MyPageVO" parameterType="MyPageVO">
		select * 
		from review
		where member_id = #{member_id}
		and store_code = #{store_code}
	</select>
	
	<select id="offerSelectList" resultType="MyPageVO" parameterType="MyPageVO">
		select o.*, s.store_name
		from offer o, store s
		where o.store_code = s.store_code
    	and member_id = #{member_id}
	</select>
	
	<select id="myOfferSelect" resultType="MyPageVO" parameterType="MyPageVO">
		select o.*, (o.offer_price*c.coupon_discount) as total_price, s.store_name, s.store_tel,s.STORE_ADDR, s.STORE_BUS, s.STORE_EMAIL,s.STORE_SUBWAY, t.storage_name, 
        t.STORAGE_PRICE, c.coupon_name
		from offer o join store s
		on (o.store_code = s.store_code)
		join storage t
		on (o.storage_code = t.storage_code)
		join coupon c
		on (o.COUPON_CODE = c.coupon_code)
		where offer_code = #{offer_code}
	</select>
	
	<select id="conveyListAll" resultType="MyPageVO" parameterType="MyPageVO">
		select a.apply_code, a.apply_product, a.apply_start, a.apply_whether, s.store_name 
		from convey_apply a, store s
		where a.store_code = s.store_code and member_id = #{member_id}
	</select>
	
	<select id="myConveySelect" resultType="MyPageVO" parameterType="MyPageVO">
		select a.*, s.store_name<if test="use_num !=null and use_num != ''">, u.info_num </if>
		from convey_apply a join store s
		on (a.store_code = s.store_code)
		<if test="use_num != null and use_num != ''">
			join use_storage u
			on (a.use_num = u.use_num)
		</if> 
		where apply_code = #{apply_code}
	</select>
	
	<select id="storeInfoSelect" resultType="MyPageVO">
		select 	store_name, store_addr, store_code
		from 	store
		where store_code like 'ST%'
	</select>
	
	<insert id="conveyInsert" parameterType="MyPageVO">
		insert into convey_apply (apply_code, member_id, 
				apply_addr, apply_product, apply_start, 
				apply_end, apply_whether, use_num, store_code)
		values('CA'||LPAD(ca_seq.nextval,3,0), #{member_id}, 
			#{apply_addr}, #{apply_product}, #{apply_start}, 
			#{apply_end}, #{apply_whether}, 
			(select use_num
			 from use_storage
			 where member_id = #{member_id}), 
			#{store_code})
	</insert>
	
	<select id="storeTourListAll" resultType="MyPageVO" parameterType="MyPageVO">
		select t.*, s.store_name
		from tour t, store s
		where t.store_code = s.store_code
		and member_id = #{member_id}
	</select>
	
	<insert id="storeTourRegist" parameterType="MyPageVO">
		insert into tour(tour_code, member_id, tour_tel, store_code, tour_date, tour_time) 
		values('TR'||LPAD(tr_seq.nextval,3,0), #{member_id}, #{tour_tel}, #{store_code}, #{tour_date}, #{tour_time})
	</insert>
	
	<update id="cancelTour" parameterType="MyPageVO">
		update tour 
		set tour_cancel = #{tour_cancel}
		where tour_code = #{tour_code}
	</update>
	
	<insert id="reviewRegist" parameterType="MyPageVO">
		insert into review(review_num, review_title, review_content, review_date, store_code, member_id)
		values(review_seq.nextval,#{review_title}, #{review_content}, sysdate, #{store_code}, #{member_id})
	</insert>
	
	<select id="noticeSelect" resultType="MyPageVO" parameterType="MyPageVO">
		select n.*, s.store_name
		from notice n, store s
		where n.store_code = s.store_code
		and notice_num = #{notice_num}
	</select>
	
	<select id="couponList" resultType="MyPageVO">
		select * 
		from coupon
	</select>
	
	<select id="reportList" resultType="MyPageVO" parameterType="MyPageVO">
		select r.*, s.store_name
		from condition_list r join use_storage u
		on (r.use_num = u.use_num)
		join store s
		on (u.store_code = s.store_code)
		where member_id = #{member_id}
	</select>
	
	<select id="reportSelect" resultType="MyPageVO" parameterType="MyPageVO">
		select r.*, s.store_name, u.use_start, u.use_end, o.offer_product
		from condition_list r join use_storage u
		on (r.use_num = u.use_num)
		join store s
		on (u.store_code = s.store_code)
		join offer o
		on (u.offer_code = o.offer_code)
		where condition_num = #{condition_num}
	</select>
</mapper>